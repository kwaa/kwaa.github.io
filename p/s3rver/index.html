<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><link rel="preload" href="&#34;//cdn.jsdelivr.net&#34;"><link rel="preconnect" href="&#34;//cdn.jsdelivr.net&#34;"><link rel="dns-prefetch" href="&#34;//i.loli.net&#34;"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@1.0.0/dist/css/mdui.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism-themes/themes/prism-material-dark.min.css"><meta name="theme-color" content="#2196F3"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><style>body,html{scroll-behavior:smooth;min-height:100vh}.mdui-hoverable:focus,.mdui-hoverable:hover{-webkit-box-shadow:0 5px 5px -3px rgba(0,0,0,.2),0 8px 10px 1px rgba(0,0,0,.14),0 3px 14px 2px rgba(0,0,0,.12)!important;box-shadow:0 5px 5px -3px rgba(0,0,0,.2),0 8px 10px 1px rgba(0,0,0,.14),0 3px 14px 2px rgba(0,0,0,.12)!important}.mdui-card-primary-title{text-decoration:none!important}.page-number{display:none!important}.mdui-container-fluid{transition:opacity .4s}.mdui-typo code,.mdui-typo pre{font-family:'Source Code Pro',Consolas,Menlo,monospace!important}body{background-color:rgba(0,0,0,.39);background-repeat:no-repeat;background-position:center center;background-size:cover;background-attachment:fixed;background-blend-mode:multiply}</style><title>S3RVER - 使用 Arch Linux 的 ALL-IN-ONE 服务器 - ./kwaa.dev</title><link rel="canonical" href="https://kwaa.dev/p/s3rver/"><meta name="description" content="新的一年我终于有预算在家里摆一小只服务器了。"><meta property="og:type" content="article"><meta property="og:title" content="S3RVER - 使用 Arch Linux 的 ALL-IN-ONE 服务器"><meta property="og:url" content="https://kwaa.dev/p/s3rver/index.html"><meta property="og:site_name" content=".&#x2F;kwaa.dev"><meta property="og:description" content="新的一年我终于有预算在家里摆一小只服务器了。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-02-02T20:20:00.000Z"><meta property="article:modified_time" content="2020-02-23T10:10:10.000Z"><meta property="article:author" content="藍"><meta name="twitter:card" content="summary"><meta name="generator" content="Hexo 5.0.0"></head><body class="mdui-theme-primary-blue mdui-theme-accent-blue mdui-appbar-with-toolbar"><div class="mdui-theme-layout-dark"><header id="appbar" class="mdui-appbar mdui-appbar-fixed mdui-shadow-0 mdui-appbar-scroll-hide"><div class="mdui-toolbar"> <button mdui-drawer="{target: '.mdui-drawer'}" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></button> <a href="/" class="mdui-typo-title">./kwaa.dev</a><div class="mdui-toolbar-spacer"></div> <a href="/search/" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon material-icons">search</i></a></div></header><aside class="mdui-drawer mdui-drawer-close"><nav class="mdui-list" mdui-collapse="{accordion: true}"><a href="/about/" class="mdui-list-item mdui-ripple"><div class="mdui-list-item-avatar"> <img src="https://i.loli.net/2020/08/03/48LIyAOVr32tChe.png"></div><div class="mdui-list-item-content">藍</div></a><div class="mdui-divider"></div> <a href="/" class="mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons">home</i><div class="mdui-list-item-content">主页</div></a><div class="mdui-collapse-item"><div class="mdui-collapse-item-header mdui-list-item mdui-ripple"> <i class="mdui-list-item-icon mdui-icon material-icons">inbox</i><div class="mdui-list-item-content">归档</div> <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i></div><div class="mdui-collapse-item-body mdui-list mdui-list-dense"> <a class="mdui-list-item mdui-ripple m-link" href="/archives/2020/07/">七月 2020</a><a class="mdui-list-item mdui-ripple m-link" href="/archives/2020/06/">六月 2020</a><a class="mdui-list-item mdui-ripple m-link" href="/archives/2020/04/">四月 2020</a><a class="mdui-list-item mdui-ripple m-link" href="/archives/2020/02/">二月 2020</a><a class="mdui-list-item mdui-ripple m-link" href="/archives/2019/11/">十一月 2019</a></div></div><div class="mdui-collapse-item"><div class="mdui-collapse-item-header mdui-list-item mdui-ripple"> <i class="mdui-list-item-icon mdui-icon material-icons">apps</i><div class="mdui-list-item-content">分类</div> <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i></div><div class="mdui-collapse-item-body mdui-list mdui-list-dense"> <a class="mdui-list-item mdui-ripple m-link" href="/categories/%E6%8A%98%E8%85%BE/">折腾</a><a class="mdui-list-item mdui-ripple m-link" href="/categories/%E6%9D%82%E8%B0%88/">杂谈</a><a class="mdui-list-item mdui-ripple m-link" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a><a class="mdui-list-item mdui-ripple m-link" href="/categories/%E9%9F%B3%E9%A2%91/">音频</a></div></div> <a href="/tags" class="mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons">local_offer</i><div class="mdui-list-item-content">标签</div></a> <a href="/links/" class="mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons">supervisor_account</i><div class="mdui-list-item-content">友链</div></a></nav><div class="mdui-divider"></div><footer class="mdui-m-l-2 mdui-m-t-1 mdui-typo mdui-text-color-theme-disabled"><p class="mdui-m-b-0"> <a href="https://kwaa.dev/atom.xml">RSS</a> | BG: <a target="_blank" rel="noopener" href="https://www.pixiv.net/artworks/61082386">星の唄</a><br> © 2019 - 2020 藍<br> Hosted on <a href="https://github.com/kwaa/kwaa.github.io" rel="noreferrer" target="_blank">Github</a><br> Powered by <a href="https://hexo.io/" rel="noreferrer" target="_blank">Hexo</a><br> Theme - <a href="https://github.com/kwaa/m" rel="noreferrer" target="_blank" mdui-tooltip="{position:'right', content: 'AB7575DD-9E94-B917-85CD-000D7FEBEAAE'}">M</a></p></footer></aside></div><div class="mdui-container-fluid" style="opacity:0"><main id="main" class="mdui-center" style="max-width:720px"><div class="mdui-theme-layout-auto mdui-color-transparent"><article class="mdui-card mdui-hoverable mdui-shadow-0 mdui-m-y-2" style="opacity:.87;border-radius:4px"><div class="mdui-card-primary mdui-ripple"> <a href="/p/s3rver/" role="heading" aria-level="1" class="mdui-card-primary-title mdui-text-color-theme-text">S3RVER - 使用 Arch Linux 的 ALL-IN-ONE 服务器</a><div class="mdui-card-primary-subtitle mdui-typo"> <span><a class="category-link" href="/categories/%E6%8A%98%E8%85%BE/">折腾</a> -</span> <span mdui-tooltip="{content:'创建时间：2020-02-02<br>最后更新时间：2020-02-23'}">2020-02-02 -</span> <span>p/s3rver/</span></div></div><div class="mdui-divider"></div><div class="mdui-card-content mdui-typo"><p>新的一年我终于有预算在家里摆一小只服务器了。</p><a id="more"></a><p>继 1OCALHOST(平板/笔记本) 和 COMPUTE2(台式机) 后，这是我现有的第三个机器；就叫它S3RVER吧。</p><h2 id="需求和配置选择">需求和配置选择</h2><p>我全都要！不太贵，低功耗，小巧；高性能（相对NAS常用的赛扬奔腾来说）。<br> 最后选择了R5-2400GE：这是R5-2400G的低功耗版，只有35W TDP。<s>AMD yes</s></p><table><thead><tr><th>合计</th><th>2440</th></tr></thead><tbody><tr><td>二手 R5-2400GE 准系统</td><td>1300</td></tr><tr><td>镁光 16G DDR4-3200 内存条</td><td>420</td></tr><tr><td>三星 256G PM981a 固态盘</td><td>300</td></tr><tr><td>西数 2T WD20SPZX 机械盘</td><td>420</td></tr></tbody></table><h2 id="系统安装">系统安装</h2><p>我最喜欢的 Arch，装了好几次已经轻车熟路了。<br> 之前用的都是 EXT4，这次试一试 btrfs</p><table><thead><tr><th>分区方案</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>/dev/nvme0n1p1</td><td>512M</td><td>/boot</td><td>fat32</td></tr><tr><td>/dev/nvme0n1p2</td><td>238G</td><td>/</td><td>btrfs</td></tr><tr><td>/dev/sda1</td><td>1.8T</td><td>/home</td><td>btrfs</td></tr></tbody></table><p>用cfdisk分区，然后格式化并创建子卷：</p><pre class="language-bash" data-language="bash"><code class="language-bash">mkfs.fat -F32 /dev/nvme0n1p1
mkfs.btrfs -f /dev/nvme0n1p2
mkfs.btrfs -f /dev/sda1
<span class="token function">mount</span> /dev/nvme0n1p2 /mnt
<span class="token builtin class-name">cd</span> /mnt
btrfs subvol create rootfs
<span class="token function">mkdir</span> -p /mnt/home
<span class="token function">mount</span> /dev/sda1 /mnt/home
<span class="token builtin class-name">cd</span> /mnt/home
btrfs subvol create homefs</code></pre><p>接下来挂载子卷：</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~
<span class="token function">umount</span> /dev/sda1
<span class="token function">umount</span> /dev/nvme0n1p2
<span class="token function">mount</span> /dev/nvme0n1p2 /mnt -o <span class="token assign-left variable">subvol</span><span class="token operator">=</span>rootfs,compress<span class="token operator">=</span>lzo,noatime,discard,ssd,space_cache
<span class="token function">mkdir</span> -p /mnt/home
<span class="token function">mount</span> /dev/sda1 /mnt/home -o <span class="token assign-left variable">subvol</span><span class="token operator">=</span>homefs,compress-force<span class="token operator">=</span>lzo,noatime,autodefrag,space_cache
<span class="token function">mkdir</span> -p /mnt/boot
<span class="token function">mount</span> /dev/nvme0n1p1 /mnt/boot</code></pre><p>修改mirrorlist，安装系统和生成fstab：</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">nano</span> /etc/pacman.d/mirrorlist <span class="token comment">#我就是喜欢用nano</span>
pacman -Syy
pacman -S archlinux-keyring
pacstrap -i /mnt base base-devel linux linux-firmware
genfstab -U /mnt <span class="token operator">>></span> /mnt/etc/fstab
<span class="token function">cat</span> /mnt/etc/fstab</code></pre><p>用arch-chroot进入安装好的系统，安装grub：</p><pre class="language-bash" data-language="bash"><code class="language-bash">pacman -S dosfstools grub efibootmgr
grub-install --target<span class="token operator">=</span>x86_64-efi --efi-directory<span class="token operator">=</span>/boot --bootloader-id<span class="token operator">=</span>arch --recheck
<span class="token function">grub-mkconfig</span> -o /boot/grub/grub.cfg</code></pre><p>安装部分就告一段落了，装个neofetch作为尾声。</p><pre class="language-bash" data-language="bash"><code class="language-bash">pacman -S neofetch
neofetch</code></pre><h2 id="其他配置">其他配置</h2><pre class="language-bash" data-language="bash"><code class="language-bash">pacman -S ufw fail2ban <span class="token comment">#防火墙</span>
pacman -S <span class="token function">zsh</span> grml-zsh-config <span class="token comment">#zsh&amp;配置</span>
<span class="token function">useradd</span> -m -g wheel -s <span class="token function">zsh</span> b917 <span class="token comment">#添加用户</span>
<span class="token function">passwd</span> b917 <span class="token comment">#设置用户密码</span></code></pre><h3 id="AUR-助手">AUR 助手</h3><p>说到 Arch 的优点，当然少不了 AUR；<br> 这里我选择了自己常用的yay。</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /tmp
<span class="token function">git</span> clone https://aur.archlinux.org/yay.git
<span class="token builtin class-name">cd</span> yay
makepkg -si</code></pre><h3 id="proxychains-ng">proxychains-ng</h3><p>活在墙国，免不了要使用代理：我直接设置成台式机的 v2ray SOCKS 端口。</p><pre class="language-bash" data-language="bash"><code class="language-bash">pacman -S proxychains-ng
<span class="token function">nano</span> /etc/proxychains.conf</code></pre><h3 id="Docker-Portainer">Docker&amp;Portainer</h3><p>这次的核心就是 Docker，我会把大多数服务都放进 Docker里运行。Portainer 是 Docker 的图形化管理界面，我用官方文档的方式安装 Portainer，并修改为44301端口。</p><pre class="language-bash" data-language="bash"><code class="language-bash">pacman -S docker
systemctl start docker
systemctl <span class="token builtin class-name">enable</span> docker
docker pull portainer/portainer
docker volume create portainer_data
docker run -d -p <span class="token number">44300</span>:8000 -p <span class="token number">44301</span>:9000 --name<span class="token operator">=</span>portainer --restart<span class="token operator">=</span>always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer</code></pre><h2 id="安装在系统的服务">安装在系统的服务</h2><h3 id="Samba">Samba</h3><blockquote><p>Samba 是 SMB/CIFS 网络协议的重新实现，可以在 Linux 和 Windows 系统间进行文件，打印机共享。</p></blockquote><p>Samba 我用来做什么？当然是放 Steam 游戏！自己电脑的1T机械盘已经快满了。我设置为分享 /home 目录，也就是整个 WD20SPZX。</p><pre class="language-bash" data-language="bash"><code class="language-bash">pacman -S samba <span class="token comment">#安装 Samba</span>
<span class="token function">nano</span> /etc/samba/smb.conf <span class="token comment">#配置 smb.conf</span>
smbpasswd -a b917 <span class="token comment">#创建用户</span>
systmctl start smb nmb <span class="token comment">#启动服务</span>
systemctl <span class="token builtin class-name">enable</span> smb nmb <span class="token comment">#激活开机自启</span></code></pre><p>我的 smb.conf 配置：</p><pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token selector">[global]</span>
<span class="token constant">    workgroup</span> <span class="token attr-value"><span class="token punctuation">=</span> WORKGROUP</span>
    server string <span class="token attr-value"><span class="token punctuation">=</span> S3RVER Samba %v</span>
    netbios name <span class="token attr-value"><span class="token punctuation">=</span> S3RVER</span>
    log file <span class="token attr-value"><span class="token punctuation">=</span> /var/log/samba/%m.log</span>
    log level <span class="token attr-value"><span class="token punctuation">=</span> 3</span>
    max log size <span class="token attr-value"><span class="token punctuation">=</span> 50</span>
<span class="token constant">    security</span> <span class="token attr-value"><span class="token punctuation">=</span> user</span>
    passdb backend <span class="token attr-value"><span class="token punctuation">=</span> tdbsam</span>
<span class="token selector">[home]</span>
<span class="token constant">    comment</span> <span class="token attr-value"><span class="token punctuation">=</span> Linux home</span>
<span class="token constant">    path</span> <span class="token attr-value"><span class="token punctuation">=</span> /home</span>
<span class="token constant">    public</span> <span class="token attr-value"><span class="token punctuation">=</span> yes</span>
<span class="token constant">    writable</span> <span class="token attr-value"><span class="token punctuation">=</span> yes</span>
<span class="token constant">    printable</span> <span class="token attr-value"><span class="token punctuation">=</span> no</span>
    valid users <span class="token attr-value"><span class="token punctuation">=</span> b917</span></code></pre><h2 id="安装在-Docker-的服务">安装在 Docker 的服务</h2><h3 id="joshava-cloudflare-ddns">joshava/cloudflare-ddns</h3><p>本来路由器一直挂着 <a target="_blank" rel="noopener" href="http://No-IP.com">No-IP.com</a> 的 DDNS，不过域名实在不怎么好看。正好现在有一台 24 小时开机的设备了，就试试 Cloudflare DDNS。</p><p>使用之前要先在 Cloudflare - My Profile - API Tokens 创建一个新的 Token，点击 Start with a template 后选择 Edit zone DNS 并设置域名即可。</p><pre class="language-bash" data-language="bash"><code class="language-bash">docker pull joshava/cloudflare-ddns
<span class="token function">touch</span> /home/b917/ddns-config.yaml <span class="token comment">#创建配置文件</span>
<span class="token function">nano</span> /home/b917/ddns-config.yaml <span class="token comment">#编辑配置文件</span>
docker run -d -v /home/b917/ddns-config.yaml:/app/config.yaml hoshava/cloudflare-ddns</code></pre><p>config.yaml的示例：</p><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">auth</span><span class="token punctuation">:</span>
    <span class="token key atrule">scopedToken</span><span class="token punctuation">:</span> token<span class="token punctuation">-</span>input<span class="token punctuation">-</span>here
<span class="token key atrule">domains</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> foo.example.com
    <span class="token key atrule">type</span><span class="token punctuation">:</span> A
    <span class="token key atrule">proxied</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">zoneId</span><span class="token punctuation">:</span> zoneid<span class="token punctuation">-</span>input<span class="token punctuation">-</span>here</code></pre><blockquote class="mdui-m-x-0 mdui-m-t-4"> <strong>作者：<a href="/about/">藍</a><br> 链接：<a href="https://kwaa.dev/p/s3rver/">https://kwaa.dev/p/s3rver/</a><br> 本文采用 <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> 进行许可。</strong></blockquote></div></article></div><nav class="mdui-theme-layout-dark mdui-color-transparent mdui-row mdui-m-b-2"><div class="mdui-col-xs-12 mdui-m-b-2"> <a class="extend prev mdui-btn mdui-ripple mdui-float-left mdui-text-truncate" rel="prev" style="max-width:100%" href="/p/project-axe/"><i class="mdui-icon mdui-icon-left material-icons">arrow_back</i>Project AXE - 旗舰耳机 DIY 计划</a></div><div class="mdui-col-xs-12"> <a class="extend next mdui-btn mdui-ripple mdui-float-right mdui-text-truncate" rel="next" style="max-width:100%" href="/p/object-storage-workers/"><i class="mdui-icon mdui-icon-right material-icons">arrow_forward</i>非常简单的Oracle对象存储代理</a></div></nav><div class="mdui-theme-layout-auto mdui-color-transparent"><div class="mdui-card mdui-hoverable mdui-shadow-0 mdui-m-y-2" style="opacity:.87;border-radius:4px"><div id="comment-container" class="mdui-card-content"><script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.setAttribute("issue-term","pathname"),t.setAttribute("theme","github-light"),t.setAttribute("repo","kwaa/comments"),t.src="https://utteranc.es/client.js",document.getElementById("comment-container").appendChild(t)}();</script></div></div></div></main></div> <a href="#" class="mdui-fab mdui-fab-fixed mdui-hidden-xs mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">keyboard_arrow_up</i></a></body><script src="https://cdn.jsdelivr.net/npm/mdui@1.0.0/dist/js/mdui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/prism.min.js"></script><script>var $=mdui.$;function fadeIn(){$(".mdui-container-fluid").css("opacity","1"),pangu.autoSpacingPage(),Prism.highlightAll(),$("body").css("background-image",'url("https://pximg.kwaa.moe/img-original/img/2017/01/23/23/51/08/61082386_p0.jpg")')}fadeIn();</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>var pjax=new Pjax({selectors:["title","meta[name=description]","#main"]});function fadeOut(){$(".mdui-container-fluid").css("opacity","0")}document.addEventListener("pjax:send",fadeOut),document.addEventListener("pjax:complete",fadeIn);</script></html>